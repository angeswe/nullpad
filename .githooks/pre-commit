#!/usr/bin/env sh

# --- static file permissions check ---
# Ensure all static files are world-readable (required for Docker serving)
STAGED_STATIC=$(git diff --cached --name-only --diff-filter=ACM -- 'static/*')
if [ -n "$STAGED_STATIC" ]; then
    BAD_PERMS=""
    for f in $STAGED_STATIC; do
        if [ -f "$f" ]; then
            # Check if file is world-readable (octal ends in 4 or higher)
            perms=$(stat -c '%a' "$f" 2>/dev/null || stat -f '%Lp' "$f" 2>/dev/null)
            last_digit=$((perms % 10))
            if [ "$last_digit" -lt 4 ]; then
                BAD_PERMS="$BAD_PERMS $f"
            fi
        fi
    done
    if [ -n "$BAD_PERMS" ]; then
        echo "pre-commit: fixing file permissions (must be world-readable for Docker)..."
        for f in $BAD_PERMS; do
            chmod 644 "$f"
            echo "  fixed: $f"
        done
        echo "$STAGED_STATIC" | xargs git add
    fi
fi

# --- cargo fmt check ---
# Auto-format staged Rust files before committing
STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM -- '*.rs')
if [ -n "$STAGED_RS" ]; then
    if command -v cargo >/dev/null 2>&1; then
        if ! cargo fmt --check >/dev/null 2>&1; then
            echo "pre-commit: running cargo fmt..."
            cargo fmt
            echo "$STAGED_RS" | xargs git add
        fi
    fi
fi

# --- vendor JS integrity ---
# Auto-update SRI hashes and license table when JS or versions.json changes
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM -- 'static/js/*.js' 'static/js/vendor/*.js' 'static/js/vendor/versions.json')
if [ -n "$STAGED_JS" ]; then
    if [ -f "tools/update-sri.sh" ]; then
        echo "pre-commit: updating SRI hashes..."
        bash tools/update-sri.sh
    fi
    if [ -f "tools/sync-licenses.sh" ]; then
        echo "pre-commit: syncing license table..."
        bash tools/sync-licenses.sh
    fi
    git diff --name-only -- 'static/*.html' | xargs -r git add
fi

# --- bd hook ---
if command -v bd >/dev/null 2>&1; then
    exec bd hook pre-commit "$@"
fi
