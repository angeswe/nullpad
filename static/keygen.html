<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keygen - Nullpad</title>
  <link rel="icon" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>nullpad <img src="/favicon.svg" alt="" class="title-icon"> keygen</h1>
      <p>Generate Ed25519 keypair from secret + alias for ADMIN_PUBKEY</p>
    </div>

    <form id="keygen-form" class="panel">
      <div class="form-group">
        <label for="alias">Alias</label>
        <input type="text" id="alias" placeholder="admin" required>
        <div class="form-help">This will be your login username</div>
      </div>

      <div class="form-group">
        <label for="secret">Secret</label>
        <input type="password" id="secret" placeholder="Your secret password" required>
        <div class="form-help">Keep this safe â€” it derives your private key</div>
      </div>

      <button type="submit" class="btn btn-primary btn-block">Generate Keypair</button>
    </form>

    <div id="result" class="panel hidden">
      <div class="panel-header">
        <h2>Generated Keypair</h2>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label>Public Key (for ADMIN_PUBKEY in .env)</label>
          <div class="copy-wrapper">
            <input type="text" id="pubkey" class="copy-input" readonly>
            <button id="copy-btn" class="copy-btn">Copy</button>
          </div>
        </div>
        <div class="alert alert-warning">
          <strong>Important:</strong> Your private key is derived from your secret + alias.
          Never share your secret. To log in, use this exact alias and secret.
        </div>
      </div>
    </div>

    <div class="alert alert-info mt-4">
      <strong>Usage:</strong>
      <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
        <li>Enter your desired alias and a strong secret</li>
        <li>Copy the generated public key</li>
        <li>Set <code>ADMIN_PUBKEY=&lt;pubkey&gt;</code> in your .env</li>
        <li>Set <code>ADMIN_ALIAS=&lt;alias&gt;</code> in your .env</li>
        <li>Restart nullpad</li>
        <li>Log in with your alias and secret</li>
      </ol>
    </div>
  </div>

  <footer class="site-footer">
    <a href="/">Back to Nullpad</a>
  </footer>

  <script src="/js/vendor/argon2.umd.min.js" integrity="sha384-tP0Wy54CKmng7i9EoTlPySD0hBx6Octj0VS6MfwlnUu111MPa+JLm0CCbep6XJ1W"></script>
  <script src="/js/auth.js" integrity="sha384-ZCUgf4tlP28D7AfftAZpxcbOCbxFRPvCw4pnisEI92yOTiEasm+8+OigEyV1EKGB"></script>
  <script>
    (function() {
      'use strict';

      const form = document.getElementById('keygen-form');
      const result = document.getElementById('result');
      const pubkeyInput = document.getElementById('pubkey');
      const copyBtn = document.getElementById('copy-btn');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const alias = document.getElementById('alias').value.trim();
        const secret = document.getElementById('secret').value;

        if (!alias || !secret) {
          alert('Please enter both alias and secret');
          return;
        }

        try {
          form.querySelector('button').disabled = true;
          form.querySelector('button').textContent = 'Generating...';

          const keypair = await NullpadAuth.deriveKeypair(secret, alias);

          pubkeyInput.value = keypair.publicKey;
          result.classList.remove('hidden');
        } catch (err) {
          alert('Error generating keypair: ' + err.message);
        } finally {
          form.querySelector('button').disabled = false;
          form.querySelector('button').textContent = 'Generate Keypair';
        }
      });

      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(pubkeyInput.value);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        } catch (err) {
          pubkeyInput.select();
          document.execCommand('copy');
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        }
      });
    })();
  </script>
</body>
</html>
